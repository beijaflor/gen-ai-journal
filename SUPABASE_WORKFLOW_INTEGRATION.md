# Supabase Admin System - Workflow Integration Guide

This document explains how the Supabase admin system integrates with the 14-step journal curation workflow.

## Overview

The Supabase admin system adds a **human-in-the-loop curation layer** to the journal workflow:

- **What it does**: Provides admin UI and database for flagging, voting, and tracking summaries
- **How it helps**: Enables pre-flagging promising content, creates audit trail, exports curation suggestions
- **Key benefits**:
  - Track editorial decisions with timestamps and user attribution
  - Vote on content quality (upvote/downvote)
  - Export flagged summaries as curation starting points
  - Preserve AI scores alongside human judgment
  - Transition summaries from draft to published state

## Quick Reference: Integration Points

| Step | Supabase Action | Script/UI | Output |
|------|----------------|-----------|--------|
| STEP_02 | None (summaries generated, no DB sync yet) | - | workdesk/summaries/ |
| STEP_03 | Admin flags summaries via UI | Browser + Auth | Supabase summary_metadata table |
| STEP_04 | Export flags to markdown | export_curation_flags.py | curated_annex_journal_sources.md, omitted_sources.md |
| STEP_10 | Mark summaries as published | mark_published.py | journal_date field updated |

---

## Admin Flagging Process (STEP_03)

### Prerequisites

- Supabase project configured (see [SUPABASE_SETUP.md](SUPABASE_SETUP.md))
- Admin user created in Supabase Auth
- Environment variables set in `website/.env`:
  ```bash
  PUBLIC_SUPABASE_URL=https://xxx.supabase.co
  PUBLIC_SUPABASE_ANON_KEY=eyJ...
  ```

### Workflow

1. **Start development server**
   ```bash
   cd website && npm run dev
   ```

2. **Sign in** at http://localhost:4321/auth/login with admin credentials

3. **Browse workdesk summaries**
   - Click on any workdesk summary from homepage sidebar
   - Summaries accessible at `/journals/[next-date]/[id]/`

4. **Flag summaries**
   - Click "Edit Curation" button (only visible when authenticated)
   - Toggle flags and votes
   - Changes auto-save to Supabase

5. **Review flagged summaries**
   - Continue flagging all summaries worth noting
   - Export flags in STEP_04 for curation assistance

### Available Flags

| Flag | Purpose | Export Behavior |
|------|---------|-----------------|
| **annex_flag** | Consider for annex journal (unique perspectives, niche value) | Exported to `curated_annex_journal_sources.md` |
| **standout_flag** | Exceptional content marker | Adds ‚≠ê marker in exports |
| **omit_flag** | Exclude from both journals (too specialized, low quality) | Exported to `omitted_sources.md` |
| **upvote_flag** | Curator endorsement (critical insight, high value) | Adds üëç marker in exports |
| **downvote_flag** | Curator concerns (hype, shallow, misleading) | Adds üëé marker in exports |

### Flag Constraints

- **Mutual exclusivity**: Cannot set both `annex_flag` AND `omit_flag` (database CHECK constraint prevents this)
- **Defaults**: All flags default to `false`
- **Scope**: Flags only apply to workdesk summaries (`journal_date IS NULL`)
- **Lazy initialization**: Database records created on first edit (no upfront sync required)

---

## Export Process (STEP_04)

### Purpose

Transform Supabase flags into markdown files that assist with editorial curation workflow.

### Script: export_curation_flags.py

**Location:** `scripts/export_curation_flags.py`

**Usage:**
```bash
uv run scripts/export_curation_flags.py
```

**Requires:**
- Environment file: `scripts/.env`
  ```bash
  SUPABASE_URL=https://xxx.supabase.co
  SUPABASE_SERVICE_KEY=eyJ...  # Keep secret! Never commit
  ```
- Python dependencies: `pip install -r requirements.txt`

**Output Files:**

#### 1. workdesk/curated_annex_journal_sources.md

Contains all summaries with `annex_flag=true`:

```markdown
# Curated Annex Journal Sources

<!-- Auto-generated by export_curation_flags.py -->
<!-- Total: 8 summaries -->

- [x] 003. https://example.com/unique-perspective ‚≠ê üëç
- [x] 012. https://example.com/niche-insight üëç
- [x] 025. https://example.com/alternative-view

```

**Markers:**
- `‚≠ê` = standout_flag=true (exceptional content)
- `üëç` = upvote_flag=true (curator endorsement)
- `üëé` = downvote_flag=true (curator concerns)

#### 2. workdesk/omitted_sources.md

Contains all summaries with `omit_flag=true`:

```markdown
# Omitted Sources

<!-- Auto-generated by export_curation_flags.py -->
<!-- Total: 2 summaries -->

- [ ] 042. https://example.com/too-specialized üëé
- [ ] 055. https://example.com/shallow-tutorial

```

### Integration with Manual Curation

**Important:** Exported files are **SUGGESTIONS**, not final decisions.

- Editor reviews these files alongside AI scores and curation criteria
- Final curation decisions remain manual (STEP_04/STEP_05)
- Apply editorial judgment based on `criteria/curation_criteria.md`
- Flags provide starting points, not mandates

---

## Publication Process (STEP_10)

### Purpose

Mark workdesk summaries as published in Supabase database, transitioning them from draft to public state.

### Script: mark_published.py

**Location:** `scripts/mark_published.py`

**Usage:**
```bash
uv run scripts/mark_published.py 2025-12-27
```

**Arguments:**
- `journal_date`: Publication date in YYYY-MM-DD format

**What it does:**

1. Queries Supabase for all workdesk summaries (`journal_date IS NULL`)
2. Displays count of summaries to be updated
3. Prompts for confirmation: `Mark 42 workdesk summaries as published for 2025-12-27? [y/N]`
4. Updates `journal_date` field to specified date
5. Returns count of updated records

**Example Session:**
```bash
$ uv run scripts/mark_published.py 2025-12-27
Found 42 workdesk summaries
Mark 42 workdesk summaries as published for 2025-12-27? [y/N] y
‚úÖ Marked 42 summaries as published for journal date 2025-12-27
```

**Effect:**

- **State Transition:** Draft (workdesk) ‚Üí Published
- **RLS Policy Change:**
  - **Before:** Only authenticated users can read (`auth.role() = 'authenticated'`)
  - **After:** Public read access enabled (`journal_date IS NOT NULL`)
- **URL Stability:** Summary URLs remain unchanged
  - Before: `/journals/2025-12-27/001/` (serves workdesk content)
  - After: `/journals/2025-12-27/001/` (serves published content)

**When to Run:**

- **Timing:** STEP_10, after archiving journals to `journals/YYYY-MM-DD/`
- **Order:** Before git commit and pull request creation (STEP_12)
- **Frequency:** Run once per journal publication
  - Script is idempotent (safe to re-run)
  - But wasteful to run multiple times

**Prerequisites:**
- `scripts/.env` configured with `SUPABASE_URL` and `SUPABASE_SERVICE_KEY`
- Python dependencies installed: `pip install -r requirements.txt`
- Workdesk summaries exist in database (`journal_date IS NULL`)

---

## Database Schema Reference

```sql
summary_metadata
‚îú‚îÄ‚îÄ id                UUID           -- Primary key
‚îú‚îÄ‚îÄ summary_id        VARCHAR(10)    -- "001", "002", etc.
‚îú‚îÄ‚îÄ url               TEXT           -- Source URL
‚îú‚îÄ‚îÄ journal_date      DATE           -- NULL = workdesk, set = published
‚îÇ
‚îú‚îÄ‚îÄ annex_flag        BOOLEAN        -- Consider for annex journal
‚îú‚îÄ‚îÄ standout_flag     BOOLEAN        -- Exceptional content (‚≠ê)
‚îú‚îÄ‚îÄ omit_flag         BOOLEAN        -- Exclude from both journals
‚îú‚îÄ‚îÄ upvote_flag       BOOLEAN        -- Curator endorsement (üëç)
‚îú‚îÄ‚îÄ downvote_flag     BOOLEAN        -- Curator concerns (üëé)
‚îÇ
‚îú‚îÄ‚îÄ ai_scores         JSONB          -- AI-generated scores (read-only in UI)
‚îÇ   ‚îî‚îÄ‚îÄ {signal, depth, unique, practical, antiHype, mainJournal, annexPotential, overall}
‚îÇ
‚îú‚îÄ‚îÄ created_at        TIMESTAMPTZ    -- Record creation timestamp
‚îú‚îÄ‚îÄ updated_at        TIMESTAMPTZ    -- Last update timestamp
‚îî‚îÄ‚îÄ updated_by        UUID           -- FK to auth.users (audit trail)

CONSTRAINTS:
- UNIQUE(summary_id, url)                 -- One flag record per source
- CHECK (NOT (annex_flag AND omit_flag))  -- Can't be both annex and omitted
```

---

## Environment Setup

### Website (Browser Client)

**File:** `website/.env`

```bash
PUBLIC_SUPABASE_URL=https://xxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

**Purpose:**
- Used by `@supabase/supabase-js` client in browser
- Enables admin UI authentication and flag editing
- Safe for public exposure (protected by RLS policies)

### Scripts (Backend/Service Key)

**File:** `scripts/.env`

```bash
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJ...  # Keep secret! Never commit to git
```

**Purpose:**
- Used by Python scripts (`export_curation_flags.py`, `mark_published.py`)
- Bypasses RLS for administrative operations
- **CRITICAL:** Never commit this file (already in .gitignore)

---

## Troubleshooting

### Admin UI Not Showing "Edit Curation" Button

**Symptoms:** No "Edit Curation" button visible on summary pages

**Checks:**
- [ ] User is authenticated (sign in via `/auth/login`)
- [ ] `PUBLIC_SUPABASE_URL` and `PUBLIC_SUPABASE_ANON_KEY` set in `website/.env`
- [ ] Dev server restarted after adding environment variables
- [ ] Browser console shows no authentication errors

**Solution:**
```bash
# Verify environment variables are loaded
cd website && npm run dev
# Check browser console for errors
# Try signing out and signing in again
```

### export_curation_flags.py Fails

**Symptoms:** Script errors or returns no results

**Checks:**
- [ ] `scripts/.env` has `SUPABASE_URL` and `SUPABASE_SERVICE_KEY`
- [ ] Python dependencies installed: `pip install -r requirements.txt`
- [ ] Supabase project is accessible (not paused)
- [ ] Service key has correct permissions

**Common Errors:**

**Error:** `"Invalid schema: public"`
- **Cause:** Supabase not exposing public schema
- **Fix:** Check Supabase dashboard ‚Üí Settings ‚Üí API ‚Üí Schema exposure

**Error:** `"No rows found"`
- **Cause:** No workdesk summaries with flags set
- **Fix:** Flag at least one summary in admin UI before running export

### mark_published.py Not Updating

**Symptoms:** Script runs but no summaries updated

**Checks:**
- [ ] Date format is YYYY-MM-DD (not MM-DD-YYYY or other format)
- [ ] Workdesk summaries exist (`journal_date IS NULL`)
- [ ] Service key has write permissions
- [ ] Confirmed 'y' at the prompt (case-sensitive)

**Common Issues:**

**Issue:** "Found 0 workdesk summaries"
- **Cause:** All summaries already published or no summaries in database
- **Fix:** Verify summaries exist and haven't been marked published yet

---

## Data Flow Diagram

```
[STEP_02] AI Summaries Generated
    ‚Üì
workdesk/summaries/001_domain.md
workdesk/summaries/002_domain.md
    ‚Üì
[STEP_03] Admin Review & Flagging
    ‚Üì
Browser UI (localhost:4321)
    ‚Üì
SummaryEditControls.astro ‚Üí supabase.upsertSummaryMetadata()
    ‚Üì
Supabase summary_metadata table
(journal_date = NULL for workdesk)
    ‚Üì
[STEP_04] Export Flags to Markdown
    ‚Üì
export_curation_flags.py
    ‚îú‚îÄ SELECT * FROM summary_metadata WHERE journal_date IS NULL
    ‚îú‚îÄ Filter: annex_flag=true ‚Üí curated_annex_journal_sources.md
    ‚îî‚îÄ Filter: omit_flag=true ‚Üí omitted_sources.md
    ‚Üì
[STEP_04-09] Manual Curation & Assembly
(Editor reviews flags alongside criteria)
    ‚Üì
journals/YYYY-MM-DD/00_weekly_journal.md
journals/YYYY-MM-DD/01_annex_journal.md
    ‚Üì
[STEP_10] Mark Summaries as Published
    ‚Üì
mark_published.py YYYY-MM-DD
    ‚Üì
UPDATE summary_metadata
SET journal_date = 'YYYY-MM-DD'
WHERE journal_date IS NULL
    ‚Üì
Summaries now publicly accessible
(RLS policy: SELECT WHERE journal_date IS NOT NULL)
    ‚Üì
URLs stable: /journals/2025-12-27/001/
(Same URL, different content source)
```

---

## Best Practices

### 1. Flag Early
Review and flag summaries immediately after STEP_02 (AI generation) while context is fresh.

### 2. Export Before Curation
Run `export_curation_flags.py` before STEP_04 to get flagged summaries as starting points for manual curation.

### 3. Treat as Guidance
Exported flags are **suggestions**, not mandates. Always apply editorial judgment and curation criteria (`criteria/curation_criteria.md`).

### 4. Mark Published Once
Only run `mark_published.py` once per journal. It's idempotent but wasteful to run multiple times.

### 5. Track Votes Over Time
Use upvote/downvote flags to build data for future curation criteria refinement:
- Which upvoted articles made it to main journal?
- Do downvoted articles have patterns (domains, topics)?
- Can voting data improve AI scoring?

### 6. Preserve AI Scores
Never manually edit or overwrite `ai_scores` field. It's read-only in the admin UI for good reason‚Äîpreserves original AI judgment.

### 7. Use Standout Sparingly
Reserve `standout_flag` for truly exceptional content (estimated: 5-10% of summaries). Overuse dilutes its value.

---

## Future Enhancements

### Display Vote Indicators in Published Journals
- Modify `content-parser.ts` to query Supabase cache during build
- Show üëç/üëé badges next to journal entries
- Display standout marker ‚≠ê for exceptional content

### Bulk Flagging Operations
- Select multiple summaries with checkboxes
- Apply flag to all selected at once
- Useful for batch operations on similar content

### Curation Analytics
- Track which flags correlate with final selection
- Generate reports: % flagged for annex vs % actually selected
- Identify drift between flags and final decisions

### Export Statistics
- Add summary section to export output
- Show metrics: total flagged, by flag type, by domain
- Track curation efficiency over time

---

## Additional Resources

- **Setup Guide:** [SUPABASE_SETUP.md](SUPABASE_SETUP.md) - Initial Supabase project configuration
- **Implementation Details:** [ADMIN_SYSTEM_IMPLEMENTATION.md](ADMIN_SYSTEM_IMPLEMENTATION.md) - Technical architecture
- **Workflow Steps:** See individual `STEP_XX_*.md` files for detailed workflow documentation
