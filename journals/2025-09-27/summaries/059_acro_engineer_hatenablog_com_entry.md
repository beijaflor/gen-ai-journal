## GPT-5の出力形式をCFGを使って強制する

https://acro-engineer.hatenablog.com/entry/2025/09/22/120000

導入されたGPT-5のCFGパラメータは、Lark文法や正規表現を活用してモデルの出力形式を厳密に制御し、構造化された正確な応答生成を確実に実現します。

**Content Type**: ⚙️ Tools

**Scores**: Signal:4/5 | Depth:4/5 | Unique:4/5 | Practical:5/5 | Anti-Hype:4/5
**Main Journal**: 86/100 | **Annex Potential**: 84/100 | **Overall**: 84/100

**Topics**: [[Generative AI, OpenAI GPT-5, 構造化出力, 文脈自由文法 (CFG), プロンプトエンジニアリング]]

アクロクエストテクノロジーの飯棲氏による本記事は、GPT-5で新たに導入されたCFG (Context-Free Grammar) パラメータの革新性と実用性を詳細に解説しています。CFGはLark文法や正規表現を用いることで、LLMの出力形式を厳密に強制できる機能であり、特にWebアプリケーションエンジニアにとって、信頼性の高いAI統合を実現する上で極めて重要です。

なぜこれが重要かというと、従来のプロンプトエンジニアリングだけでは、LLMが意図しない形式や、定義外の要素（例：今回はSUM()関数）を生成する「ハルシネーション」を完全に防ぐことが困難でした。しかし、CFGを活用すれば、入れ子や再帰的な構造を含む複雑な形式であっても、Lark文法で記述した通りにモデルの出力を保証できます。これにより、LLMが生成した結果をそのままデータベースのクエリやAPIのペイロード、コードの一部として利用する際の信頼性が飛躍的に向上します。

記事では、CosmosDBのクエリ生成を具体的なユースケースとして取り上げ、`SELECT VALUE ... WHERE ... ORDER BY ...`という限定的な文法をLarkで定義し、GPT-5に強制するデモンストレーションを行っています。シンプルなクエリから複雑な複数条件クエリ、さらには文法に逸脱する要素（SUM()やGROUP BY）を含む要求に対しても、定義された文法のみに従った正確なクエリが出力されることを実証。これにより、開発者はLLMの出力をプログラムで直接安全に扱えるようになり、後処理ロジックの簡素化やエラー発生の抑制、ひいては開発効率の向上に直結します。

CFGは現時点ではResponses APIでのみ利用可能といった制限はあるものの、LLMの「構造化出力」という長年の課題に対する強力なソリューションであり、生成AIを基盤とした堅牢なシステム構築を目指すエンジニアにとって、その活用は必須となるでしょう。特に、特定のデータベース構文やデータスキーマに厳密に従う必要があるアプリケーション開発において、その価値は計り知れません。