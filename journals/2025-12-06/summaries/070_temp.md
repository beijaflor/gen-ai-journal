## Code execution with MCP: Building more efficient agentsを読んでみる

https://zenn.dev/headwaters/articles/b179599d4947f1

Anthropicが提案するAIエージェントのコード実行アプローチは、モデルコンテキストプロトコル(MCP)を利用する際に発生するトークン過負荷とコスト増大の問題を、ツール定義のオンデマンド読み込みとコードによる中間データ処理によって解決し、エージェントの効率と堅牢性を大幅に向上させます。

**Content Type**: Tutorial & Guide
**Language**: ja

**Scores**: Signal:4/5 | Depth:4/5 | Unique:4/5 | Practical:5/5 | Anti-Hype:5/5
**Main Journal**: 89/100 | **Annex Potential**: 88/100 | **Overall**: 88/100

**Topics**: [[AIエージェント, モデルコンテキストプロトコル (MCP), コード実行, トークン効率, コンテキスト管理]]

この記事は、AIエージェントが外部システムと連携するためのオープン標準であるモデルコンテキストプロトコル（MCP）が広く普及する中で、エージェントの効率低下を招く問題点とその解決策を解説しています。従来のMCPクライアントでは、数多くのツールが接続されると、その全定義が事前にモデルのコンテキストウィンドウに読み込まれ、また中間ツール実行結果もモデルを介して渡されるため、トークン消費が過剰となり、コスト増大やレイテンシの増加という課題がありました。特に、数千のツールに接続されたエージェントでは、リクエスト処理前に数十万ものトークンが消費される可能性も指摘されています。

この根本的な課題に対処するため、著者は「コード実行」という先進的なアプローチを提案しています。これは、MCPサーバーへの直接的なツール呼び出しではなく、エージェントがMCPサーバーをコードAPIとして扱い、実行環境でTypeScriptなどのコードを生成・実行することで対話するというものです。具体的には、利用可能なツール群をファイルツリーとして表現し、エージェントは現在のタスクに必要なツール定義のみをオンデマンドで読み込みます。この手法により、例えばGoogle Driveからドキュメントを取得してSalesforceに添付するようなワークフローで、従来の15万トークンからわずか2千トークンへと、約98.7%という劇的なトークン削減が実現可能であると説明されています。

このコード実行アプローチは、ウェブアプリケーションエンジニアにとって特に魅力的な複数の利点をもたらします。

1.  **コンテキスト効率の劇的な向上**: 必要なツール定義のみを読み込み、大規模なデータセットのフィルタリングや変換、集計といった処理をモデルに結果を返す前に実行環境で行うことで、トークン消費を大幅に削減し、コストとレイテンシを改善します。
2.  **段階的なツール開示**: エージェントはファイルシステムをナビゲートしてツールを発見し、タスクの進捗に応じて必要な詳細レベル（名前のみ、スキーマを含む完全な定義など）のツール情報を選択的に読み込むことができます。
3.  **より強力な制御フロー**: ループ、条件分岐、エラー処理といった複雑なロジックを、エージェントループ内のメッセージングを介さず、コード内で直接かつ効率的に実行できます。これにより、より複雑で堅牢なワークフローの構築が可能になります。
4.  **プライバシー保護操作**: 中間結果はデフォルトで実行環境に残り、ユーザーが明示的にログに記録または返したもののみがモデルに共有されます。個人を特定できる情報（PII）などはモデルに渡る前に自動的にトークン化することも可能で、機密データの誤処理リスクを低減します。
5.  **状態の永続化とスキルの蓄積**: エージェントは中間結果をファイルに書き込み、作業の状態を維持することで、長時間のタスクや中断からの再開を容易にします。また、開発したコードを再利用可能な「スキル」（関数）としてファイルシステムに保存し、将来のタスクで活用することで、エージェント自身の学習とパフォーマンスを向上させることができます。

ただし、著者は、コード実行には適切なサンドボックス、リソース制限、監視を備えた安全な実行環境の構築が必要であり、運用上のオーバーヘッドやセキュリティに関する考慮事項が追加されることも強調しています。しかし、トークンコスト削減、レイテンシ短縮、ツール構成の改善といった実用的なメリットは、これらの実装コストを上回る価値があり、AIエージェント開発における重要な設計パラダイムシフトとなることを示唆しています。