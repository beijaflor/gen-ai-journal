## Strands AgentsでClaudeモデルのプロンプトキャッシュを使う方法

https://qiita.com/moritalous/items/062b06bed7b4a08f5fad

最適化する。Strands AgentsのHooks機能を活用し、Amazon Bedrock上で動作するClaudeモデルのプロンプトキャッシュ管理を自動化する手法を解説する。

**Content Type**: ⚙️ Tools
**Language**: ja

**Scores**: Signal:4/5 | Depth:3/5 | Unique:4/5 | Practical:5/5 | Anti-Hype:4/5
**Main Journal**: 81/100 | **Annex Potential**: 80/100 | **Overall**: 80/100

**Topics**: [[Amazon Bedrock, Anthropic Claude, プロンプトキャッシュ, Strands Agents, エージェント開発]]

Strands Agentsは、LLMを用いたエージェントのループ処理を抽象化するフレームワークですが、Amazon Bedrockで提供されている「Claudeプロンプトキャッシュ」をエージェントの自動化された対話の中で効率的に適用するには、キャッシュポイントの挿入タイミングを制御する必要があります。著者は、Strands Agentsの「Hooks」機能を利用することで、開発者が手動でメッセージ構造を操作することなく、自動的にプロンプトキャッシュを最適化する洗練された実装パターンを提示しています。

具体的には、LLMへのリクエスト送信前に実行される`BeforeModelCallEvent`で最新メッセージにキャッシュポイントを追加し、レスポンス受け取り後の`AfterModelCallEvent`でそのキャッシュポイントを削除するというライフサイクル管理を行っています。筆者によれば、Claudeのプロンプトキャッシュには「同時に指定できるキャッシュポイントは最大4つまで」という制限があるため、この動的な追加・削除のアプローチが非常に有効であると主張しています。これにより、複数ターンのメッセージのやり取りが発生するエージェントループにおいて、コンテキストの肥大化に伴うコスト増加とレイテンシの悪化を効果的に抑制することが可能になります。

また、筆者は実用上の注意点として、Claude 3.5 Haikuなどのモデルでは4,096トークン以下の入力はキャッシュされないといった仕様上の制限にも言及しており、単なるコードの紹介に留まらない実践的なガイダンスを提供しています。エージェント型アプリケーションの構築において、高い抽象度を保ちながらインフラレイヤーの最適化機能を「しれっと」共存させるこの手法は、スケーラブルなAIシステムを設計するウェブエンジニアにとって極めて実用性の高い知見と言えます。エージェントワークフローにおけるTTFT（最初のトークンが出るまでの時間）の改善はUXに直結するため、Bedrockを利用する開発者にとって必須のパターンとなり得るでしょう。