## なぜAI AgentにSQLを直接触らせず、dbt showを使わせたのか

https://takimo.tokyo/2604aebf66ad8067a25ccd25e459da97

AIエージェントにSQLを直接記述させるリスクを回避し、dbtの`dbt show`コマンドを活用することで、安全かつ再現性高くデータパイプラインを調査するワークフローを構築する方法を解説します。

**Content Type**: Tools

**Scores**: Signal:4/5 | Depth:4/5 | Unique:4/5 | Practical:5/5 | Anti-Hype:5/5
**Main Journal**: 88/100 | **Annex Potential**: 87/100 | **Overall**: 88/100

**Topics**: [[AIエージェント, dbt, データパイプライン, SQLセキュリティ, 開発ワークフロー効率化]]

AIエージェントをデータパイプラインの調査に活用する際、直接SQLを記述させる方式には、フルパスの未把握による失敗、重いクエリ生成によるコスト増、DDL生成リスク、コンテキスト肥大化といった多くの課題が伴います。本記事は、これらの課題を解決するため、dbtの抽象化レイヤーと`dbt show`コマンドを組み合わせた、安全かつ再現性の高いデータ調査ワークフローの構築方法を提案します。

dbtはSQLを抽象化した「モデル」として管理し、開発者はフルパスを知らずにモデル名で操作できます。この特性をAIエージェントにも適用するため、筆者は副作用のないSELECTクエリのみを実行できる`dbt show`コマンドの利用を推奨。これにより、AIに与える情報量を最小化し、不要なコンテキストを削減できます。ただし、`dbt show --target`オプションには任意のSQLが実行されるセキュリティリスクがあるため、入力されたクエリをサブクエリでラップする暫定的なラッパーコマンドの実装例も提示しています。

具体的な調査ワークフローでは、ユーザーからの商品ID調査依頼に対し、AIが事前定義されたMarkdown形式の手順書に従い、下流から上流へとデータモデルを段階的に確認します。調査結果はブランチ単位でローカルに保存され、人間によるレビューとナレッジ化を促進。このドキュメントドリブンなアプローチと`dbt show`の活用により、属人化していた調査プロセスを機械的かつ再現可能な形に変換し、安全かつ最小限のコンテキストでAIを運用する道を開きます。

将来的な展望として、dbt Labsが発表したdbt MCP Serverとの連携にも触れ、AIエージェントがdbtプロジェクト全体を安全に探索・利用できるようになる可能性を示唆します。ウェブアプリケーションエンジニアにとって、この手法はデータ品質が特に重要な商品マスタのような複雑なデータパイプラインにおいて、AIを活用したデータ調査の効率化と信頼性向上に直結する、非常に実用的なアプローチとなるでしょう。