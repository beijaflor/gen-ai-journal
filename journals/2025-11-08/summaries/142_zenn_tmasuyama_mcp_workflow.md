## Anthropic公式のMCPサーバー設計術！98.7%のトークン削減を実現

https://zenn.dev/tmasuyama1114/articles/anthropic_mcp_workflow

Anthropicが、Claudeエージェントのトークン消費を98.7%削減する「コード実行パターン」を公式に発表し、動的なツールロードによる効率的なエージェント開発を提案します。

**Content Type**: Tutorial & Guide
**Language**: ja

**Scores**: Signal:4/5 | Depth:4/5 | Unique:3/5 | Practical:5/5 | Anti-Hype:4/5
**Main Journal**: 100/100 | **Annex Potential**: 100/100 | **Overall**: 80/100

**Topics**: [[LLMエージェント, トークン最適化, Anthropic Claude, 開発ワークフロー, API利用効率化]]

MCP（Model Context Protocol）を利用したClaudeエージェントの開発において、ツール定義の増加が深刻なトークン消費問題を引き起こしています。従来の設計では、エージェントが利用可能な全てのツール定義（引数の型、説明文、使い方など）を前段で読み込む傾向があり、例えば1リクエストあたり150,000トークンもの文脈が生成されるケースがあると指摘されています。これは、スーパーで買い物をする際に毎回全商品の分厚いカタログを持ち歩くような非効率さであり、結果としてAPIコストの急増、レスポンスの遅延、そしてシステムの拡張性の限界という3つの大きな課題を生じさせます。

Anthropicがこの問題に対し、公式エンジニアリングブログで提唱しているのが「コード実行パターン」です。これは、エージェントに「完成品（ツールの実行結果）」を直接注文するのではなく、「レシピ本（コードとAPI）」を提供して必要な時に必要なものだけを作らせる、という発想の転換を促します。この手法の核となるのは、「ファイルシステムベースのツール管理」と「動的ツールロード」の二つのアイデアです。

まず「ファイルシステムベースのツール管理」では、ツール群を`servers/google-drive/getDocument.ts`のように、実際のファイルシステムのように階層的に整理します。これにより、エージェントは全体像を把握しつつも、特定のタスクに必要なツールだけを「目次を読んで本を取り出す」ように選択的に参照できるようになります。次に「動的ツールロード」は、エージェントが実行時に必要なツール定義だけをその場で読み込む仕組みです。具体的には、エージェントが「Google Driveからファイルを取得したい」と判断した場合、ファイルシステムを探索するか検索ツールで候補を絞り込み、そのツールの定義だけを読み込んでコードを生成・実行します。

記事では、Google DriveからSalesforceへのデータ移行を例に具体的な実装フローが示されています。エージェントはまず、例えば`gdrive.getDocument`と`salesforce.updateRecord`といった必要なツール定義を動的にロードし、それらのツールを利用するTypeScriptコードを生成・実行します。この結果、元記事では約150,000トークンから約2,000トークンへと、驚異的な98.7%のトークン削減が報告されており、その効果はツールの構成やワークロードによって変動しつつも非常に大きいと述べられています。

この「コード実行パターン」を導入することで、開発者はClaudeエージェントの柔軟性と効率性を両立させ、トークン消費の最適化によるコスト削減、レスポンス速度の向上、そして持続可能なスケーラビリティを実現できます。筆者は、この手法が小規模なプロジェクトにも応用可能であり、AI駆動開発の現場に大きなメリットをもたらすと強調しています。