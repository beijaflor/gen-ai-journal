## Claude Codeが並列にSubAgentを起動した時に自宅ネットワークが死ぬ問題を解消した

https://blog.shibayu36.org/entry/2025/11/11/110301

Claude CodeのSubAgent並列起動時に発生する自宅ネットワーク障害を、v6プラスからDS-LiteへのISP契約変更で解決した。

**Content Type**: ⚙️ Tools
**Language**: ja

**Scores**: Signal:4/5 | Depth:4/5 | Unique:4/5 | Practical:5/5 | Anti-Hype:5/5
**Main Journal**: 100/100 | **Annex Potential**: 100/100 | **Overall**: 88/100

**Topics**: [[Claude Code, AIエージェント, ネットワークトラブルシューティング, v6プラス, DS-Lite]]

著者は、Claude Codeが同時に4〜5個のSubAgentを起動すると、自宅ネットワークが完全に停止する問題に直面しました。この問題は、AIエージェントを活用した開発ワークフローにおいて、予期せぬインフラのボトルネックが生じる可能性を示唆しています。

問題の調査は、ルーターのログ機能がないことから、WiresharkでのパケットキャプチャやChatGPTによる分析から始まり、NAT関連の問題が疑われました。特に、知人からの助言により、著者の自宅ネットワークで利用しているv6プラス（MAP-E方式）が、ISP側でIPv4通信のポート数を約240に制限していることが原因ではないかとの仮説が浮上しました。

この仮説を検証するため、PPPoE環境やスマートフォンのテザリング環境で試したところ、いずれの環境でもネットワーク障害は発生せず、ISP側のポート数制限が原因である可能性が高まりました。解決策として、ポートセービングIPマスカレード機能を持つ新しいルーターの購入か、ISP契約をDS-Lite方式に変更する方法が検討されました。著者は月額200円増で利用できるenひかりの「超transix」（DS-Lite方式で約12800ポート確保可能）へ契約を切り替えることを選択しました。

その結果、Claude Codeが並列にSubAgentを起動してもネットワークが停止する問題は無事に解消されました。しかし、著者は、TCP同時接続数が100程度とポート制限数（240）に達していないにもかかわらず障害が発生した点や、IPv6通信にはポート制限が関係しない点から、根本原因の完全な解明には至っていないと述べています。ルーターのNATテーブル管理における実装依存性や、TCP接続終了後のNATセッション維持などが複合的な要因である可能性を示唆しています。

この記事は、AIエージェントを積極的に利用するWebアプリケーションエンジニアにとって、自宅や小規模オフィス環境のネットワークがAIツールの高並列処理によってボトルネックになる可能性と、その具体的な解決策（特に日本のv6プラス環境におけるISP契約の見直し）を示す点で非常に実践的です。AIツール導入時の予期せぬインフラ課題に対する洞察を提供し、ネットワーク知識の重要性を再認識させます。