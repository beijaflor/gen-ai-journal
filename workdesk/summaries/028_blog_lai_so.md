## Claude CodeにLSPツールが追加

https://blog.lai.so/claude-code-lsp/

巨大なコードベースにおけるシンボル探索や定義参照をSemanticに実行し、探索精度の向上とコンテキストトークンの削減を実現するLSP統合機能を評価する。

**Content Type**: ⚙️ Tools
**Language**: ja

**Scores**: Signal:4/5 | Depth:4/5 | Unique:3/5 | Practical:5/5 | Anti-Hype:4/5
**Main Journal**: 81/100 | **Annex Potential**: 77/100 | **Overall**: 80/100

**Topics**: [[Claude Code, LSP, AIエージェント, コード探索, トークン最適化]]

Claude Code（Anthropicが提供するCLIベースのAIエージェント）のバージョン2.0.74以降において、LSP（Language Server Protocol）ツールが試験的に導入された。これまでSerenaなどの外部ツールが担っていた言語サーバーの統合機能が公式にサポートされた形だ。筆者はこの新機能について、大規模なリポジトリにおける探索効率とコストの両面から検証を行っている。

**なぜ重要か：大規模リポジトリ探索の最適化**
Webアプリケーションエンジニアが数万行を超えるコードベースでAIエージェントを利用する際、最大のボトルネックは「情報の探索精度」と「コンテキストトークンの消費量」にある。従来のGrepベースの検索では、テキスト一致のみを頼りに大量のファイルを読み込むため、不要な情報がコンテキストを圧迫し、結果として推論精度が低下しコストが増大する傾向があった。
著者の検証によれば、LSPツールの導入によって以下のメリットが得られるという。
1. **探索精度の向上**: `findReferences` や `documentSymbol` などのセマンティックな操作により、目的のコードに最短距離で到達できる。
2. **トークンの削減**: 従来のGrep検索とReadツール（ファイル読み込み）を組み合わせたケースと比較して、同等のタスクで約13%のトークン削減を確認している。
3. **レポート品質の改善**: LSPから得られる詳細な型情報やシンボル情報をエージェントが利用することで、分析レポートの具体性が増す。

**具体的な実装と活用方法**
導入は `/plugin` コマンドまたは `.claude-plugin/plugin.json` への記述で行う。`typescript-language-server` などの標準的なLSPサーバーをプラグインとして登録し、環境変数 `ENABLE_LSP_TOOL=1` を指定して起動することで有効化される。筆者はTypeScriptのほか、PHP、Go、Rust、Pythonなど主要な言語での動作を確認している。

**現状の限界と運用の勘所**
ただし、現時点でのLSPツールは万能ではない。筆者は以下の点に注意を促している。
- **読み込み専用**: 現在の機能はシンボル検索などの「読み」に限定されており、リファクタリングなどの書き込み操作は提供されていない。
- **フォールバックの必要性**: `workspaceSymbol` などの操作で十分な結果が得られない場合、エージェントは依然としてGrepに頼る。
- **明示的な指示**: エージェントが自律的にLSPを使いこなせない場面があるため、プロンプトで「LSPで検索して」と指示を出すことが有効なワークアラウンドとなる。

巨大なコードベースを扱うエンジニアにとって、Claude CodeのLSP統合は、開発コストを抑えつつエージェントの理解度を一段階引き上げる実用的なアップデートと言える。