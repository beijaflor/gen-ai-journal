---
import { withBase } from '@/utils/base-path';
import type { JournalArchive } from '@/utils/content-parser';

export interface Props {
  journalData: JournalArchive;
  showExcerpt?: boolean;
  showActions?: boolean;
}

const {
  journalData,
  showExcerpt = true,
  showActions = true,
} = Astro.props;

// Format date for display
const displayDate = new Date(journalData.date).toLocaleDateString('ja-JP', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  weekday: 'long'
});

// Calculate total reading time
const totalReadingTime = (journalData.mainJournal?.readingTime || 0) + (journalData.annexJournal?.readingTime || 0);
const readingTimeText = totalReadingTime === 1 ? '1分で読めます' : `${totalReadingTime}分で読めます`;

// Check what content exists
const hasMainJournal = !!journalData.mainJournal;
const hasAnnexJournal = !!journalData.annexJournal;
const hasBothJournals = hasMainJournal && hasAnnexJournal;
---

<article class="weekly-journal-card">
  <header class="card-header">
    <div class="header-main">
      <h3 class="week-title">
        <a href={withBase(`/journals/${journalData.date}/`)}>
          {displayDate}号
        </a>
      </h3>
      <div class="week-meta">
        <time datetime={journalData.date} class="publish-date">
          {displayDate}
        </time>
        <div class="journal-types">
          {hasMainJournal && (
            <span class="journal-type type-main">メイン</span>
          )}
          {hasAnnexJournal && (
            <span class="journal-type type-annex">アネックス</span>
          )}
        </div>
      </div>
    </div>
    
    <div class="reading-info">
      <span class="reading-time">{readingTimeText}</span>
      {journalData.stats.totalSummaries > 0 && (
        <span class="summary-count">
          {journalData.stats.totalSummaries}件のサマリー
        </span>
      )}
    </div>
  </header>

  {showExcerpt && (hasMainJournal || hasAnnexJournal) && (
    <div class="journals-content">
      <div class={`journals-grid ${hasBothJournals ? 'two-columns' : 'single-column'}`}>
        {hasMainJournal && (
          <div class="journal-section main-section">
            <div class="section-header">
              <h4 class="section-title">メインジャーナル</h4>
              <span class="reading-time-small">
                {journalData.mainJournal?.readingTime}分
              </span>
            </div>
            <h5 class="journal-title">
              <a href={withBase(`/journals/${journalData.date}/main/`)}>
                {journalData.mainJournal?.title}
              </a>
            </h5>
            {journalData.mainJournal?.excerpt && (
              <p class="journal-excerpt">{journalData.mainJournal.excerpt}</p>
            )}
            <div class="journal-stats">
              <span class="word-count">{journalData.mainJournal?.wordCount.toLocaleString()}文字</span>
            </div>
          </div>
        )}
        
        {hasAnnexJournal && (
          <div class="journal-section annex-section">
            <div class="section-header">
              <h4 class="section-title">アネックス</h4>
              <span class="reading-time-small">
                {journalData.annexJournal?.readingTime}分
              </span>
            </div>
            <h5 class="journal-title">
              <a href={withBase(`/journals/${journalData.date}/annex/`)}>
                {journalData.annexJournal?.title}
              </a>
            </h5>
            {journalData.annexJournal?.excerpt && (
              <p class="journal-excerpt">{journalData.annexJournal.excerpt}</p>
            )}
            <div class="journal-stats">
              <span class="word-count">{journalData.annexJournal?.wordCount.toLocaleString()}文字</span>
            </div>
          </div>
        )}
      </div>
    </div>
  )}

  {showActions && (
    <footer class="card-actions">
      <div class="primary-actions">
        {hasMainJournal && (
          <a href={withBase(`/journals/${journalData.date}/main/`)} class="btn btn-primary">
            メイン記事を読む
          </a>
        )}
        {hasAnnexJournal && (
          <a href={withBase(`/journals/${journalData.date}/annex/`)} class="btn btn-primary">
            アネックスを読む
          </a>
        )}
      </div>
      
      <div class="secondary-actions">
        <a href={withBase(`/journals/${journalData.date}/`)} class="btn btn-outline">
          週の概要
        </a>
        {journalData.stats.totalSummaries > 0 && (
          <a href={withBase(`/journals/${journalData.date}/summaries/`)} class="btn btn-outline">
            全サマリー ({journalData.stats.totalSummaries})
          </a>
        )}
      </div>
    </footer>
  )}
</article>

<style>
  .weekly-journal-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.875rem;
    padding: 1.75rem;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    transition: all 0.2s ease;
  }

  .weekly-journal-card:hover {
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border-color: #d1d5db;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .header-main {
    flex: 1;
    min-width: 0;
  }

  .week-title {
    margin: 0 0 0.75rem 0;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .week-title a {
    color: #1f2937;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .week-title a:hover {
    color: #2563eb;
    text-decoration: none;
  }

  .week-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .publish-date {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .journal-types {
    display: flex;
    gap: 0.5rem;
  }

  .journal-type {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .type-main {
    background: #dbeafe;
    color: #1e40af;
  }

  .type-annex {
    background: #fef3c7;
    color: #92400e;
  }

  .reading-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .reading-time {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
  }

  .summary-count {
    color: #9ca3af;
    font-size: 0.75rem;
    white-space: nowrap;
  }

  .journals-content {
    margin-bottom: 1.5rem;
  }

  .journals-grid {
    display: grid;
    gap: 1.5rem;
  }

  .journals-grid.single-column {
    grid-template-columns: 1fr;
  }

  .journals-grid.two-columns {
    grid-template-columns: 1fr 1fr;
  }

  .journal-section {
    padding: 1.25rem;
    background: #f8fafc;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .main-section {
    border-left: 4px solid #3b82f6;
  }

  .annex-section {
    border-left: 4px solid #f59e0b;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .section-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .reading-time-small {
    color: #9ca3af;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .journal-title {
    margin: 0 0 0.75rem 0;
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.4;
  }

  .journal-title a {
    color: #1f2937;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .journal-title a:hover {
    color: #2563eb;
    text-decoration: none;
  }

  .journal-excerpt {
    color: #4b5563;
    line-height: 1.6;
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .journal-stats {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #9ca3af;
    font-size: 0.75rem;
  }

  .word-count {
    font-weight: 500;
  }

  .card-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f3f4f6;
  }

  .primary-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .secondary-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    white-space: nowrap;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
    text-decoration: none;
  }

  .btn-outline {
    background-color: transparent;
    color: #2563eb;
    border: 1px solid #2563eb;
  }

  .btn-outline:hover {
    background-color: #2563eb;
    color: white;
    text-decoration: none;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .weekly-journal-card {
      padding: 1.25rem;
    }

    .card-header {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .reading-info {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    .week-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .journals-grid.two-columns {
      grid-template-columns: 1fr;
    }

    .journal-section {
      padding: 1rem;
    }

    .primary-actions,
    .secondary-actions {
      flex-direction: column;
    }

    .btn {
      justify-content: center;
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .weekly-journal-card {
      padding: 1rem;
    }

    .week-title {
      font-size: 1.25rem;
    }

    .journal-title {
      font-size: 1rem;
    }

    .btn {
      width: 100%;
    }
  }
</style>